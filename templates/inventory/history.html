{% extends 'inventory/base.html' %}
{% load static %}
{% load custom_tags %}
{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">ðŸ“œ Change History</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
        {% endfor %}
    {% endif %}
 
    <!-- Optional filter -->
    <form method="get" class="mb-3">
        <label for="model" class="form-label">Filter by model:</label>
        <select name="model" onchange="this.form.submit()" class="form-select w-auto d-inline">
            <option value="all" {% if not model or model == 'all' %}selected{% endif %}>All</option>
            {% for model_filter in models_filter  %}
            <option value="{{model_filter}}" {% if model|stringformat:"s" == model_filter %}selected{% endif %}>{{model_filter}}</option>{% endfor %}
            {% comment %} {% for m in model_list %}
                <option value="{{ m }}" {% if model == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %} {% endcomment %}
        </select>

    <label for="user" class="form-label">Filter by user:</label>
    <select name="user_id" onchange="this.form.submit()" class="form-select w-auto d-inline">
       
        <option value="all" {% if not selected_user_id or selected_user_id == 'all' %}selected{% endif %}>All</option>
        {% if users %}
            {% for u in users %}
            
                <option value="{{ u.id }}" {% if  selected_user_id|stringformat:"s" == u.id|stringformat:"s"   %}selected{% endif %}>{{ u }}</option>
            {% endfor %}
        {% endif %}
    </select>
       <label for="date" class="form-label mb-0">Filter by Date:</label>
    <input type="text" id="date" name="date" class="form-control flatpickr_date w-auto d-inline" placeholder="Select date" value="{{ request.GET.date }}" />
    <button type="submit"  class="btn btn-primary btn-sm" >Apply</button>   
</form>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    flatpickr('.flatpickr_date', {
      enableTime: false,
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'F j, Y'
    })
  </script>



    {% if history %}
        <div class="row g-3">
            {% for h in history %}
                <div class="col-12 col-md-6">
                    {{ forloop.revcounter  }}
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                {{ h.content_type.model|capfirst }}  
                                <small class="text-muted"><a href="{{ h.content_object|get_link }}">{{h.content_object}}s</a>

                            </h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                {% if h.created %}
                                Created by <strong>{{ h.user }}</strong>{% else %}Changed by <strong>{{ h.user }}</strong>  {% endif %}{% if h.created_by_syncing or h.updated_by_syncing %}<span class="badge bg-primary">in syncing mode ðŸ”„</span>{% endif %}
                                <br>
                                <small>At: {{ h.changed_at|date:'Y-m-d H:i' }}</small>
                            </h6>{% if not h.created %}
                            <p class="mb-1">
                                <strong>Field:</strong> {{ h.field }}
                            </p>
                            
                            <p class="text-danger mb-1"><strong>Old:</strong> {{ h.old_value|default:"(empty)" }}</p>
                            <p class="text-success mb-1"><strong>New:</strong> {{ h.new_value|default:"(empty)" }}</p>
                        {% endif %}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">No changes found in history.</div>
    {% endif %}
</div>

<link rel="stylesheet" href="{% static 'css/style.css' %}" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
{% endblock %}
