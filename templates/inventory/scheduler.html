{% extends 'inventory/base.html' %}
{% load static %}
{% block title %}
  Scheduler - Stocky
{% endblock %}
{% block body %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800" style="
    background: linear-gradient(90deg, #312e11ff, #ff5733, #ff33a6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 600;
    ">Scheduler Assistant</h1>
    <p>The following groups were generated at: {{ ex_sg.created_at }}</p>
  </div>
  <form action="" method="post" class="d-flex gap-3 align-items-center mt-3">
    {% csrf_token %}

    <button name="regenerate" type="submit" class="btn fw-bold shadow-sm px-4 py-2 rounded-pill" style="background: linear-gradient(90deg, #007bff, #22434eff); color: white; border: none;">üîÑ Regenerate</button>

    <button name="optimize" type="submit" class="btn fw-bold shadow-sm px-4 py-2 rounded-pill" style="background: linear-gradient(90deg, #28a745, #5d866eff); color: white; border: none;">‚öôÔ∏è Optimize</button>
  </form>

  <span style="background-color: black;">‚ö†Ô∏è <small style="
    
    background: linear-gradient(90deg, #fce100);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 600;
  ">Note: Optimization results may not be 100% accurate. Always double-check on maps.</small></span>
  {% for group in groups %}
    {% if not group.wrong_postcodes %}
      <div class="card my-3 shadow-sm border-0" id="{{group.id}}" onclick="localStorage.setItem('lastJob',{{group.id}});">
        <!-- Card Header -->
        <div class="card-header text-white fw-bold d-flex justify-content-between align-items-center" style="background-color: #404960ff;">
          <span> {{group.id}} Group {{ forloop.counter }} ‚Äî {{ group.jobs.all|length }} job{{ group.jobs.all|length|pluralize }}</span>

          {% if group.optimized_at %}
            <span style="
      background: linear-gradient(90deg, #a7e26fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 600;
      text-shadow: 0 0 8px rgba(38, 172, 225, 0.54);
    ">Route Optimized at: {{ group.optimized_at }}</span>
          {% endif %}

          {% if group.map_url %}
            <a href="{{ group.map_url }}" target="_blank" class="btn btn-light btn-sm fw-bold px-3 py-1 shadow-sm" style="border-radius: 20px;"><i class="bi bi-geo-alt-fill me-1"></i> View on maps</a>
          {% endif %}
        </div>

        <!-- Job List -->
        <ul class="list-group list-group-flush">
          {% for job in group.ordered_jobs %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {{ job.id }}
                <a href="{% url 'update_job' job.job_id %}" class="fw-bold text-decoration-none text-primary">{{ job.job_id }}</a>
                <span class="text-muted">‚Äî {{ job.address }}-{{ job.post_code }}</span>
              </div>
              <div><form action="" method="post" class="d-inline-flex align-items-center gap-1 m-0 p-0" style="font-size: 0.85rem;">
  {% csrf_token %}
  <input type="hidden" name="group_id" value="{{ group.id }}">
  <input type="hidden" name="job_id" value="{{ job.id }}">

  <button type="submit" name="move_up" value="{{ job.id }}" 
          class="btn btn-light btn-sm p-0 px-1 border-0" title="Move Up"  style="color: #16a34a; ">‚ñ≤</button>

  <button type="submit" name="move_down" value="{{ job.id }}" 
          class="btn btn-light btn-sm p-0 px-1 border-0" title="Move Down" style="color: red;">‚ñº</button>

  <select name="new_group" onchange="this.form.submit()" 
          
          style="font-size: 0.8rem;">
    {% for group_options in groups %}
      <option value="{{ group_options.id }}" {% if group_options.id == group.id %}selected{% endif %}>
        Group-{{ forloop.counter }}
      </option>
    {% endfor %}
  </select>
</form>

              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <!-- Card for groups without map_url -->
  {% empty %}
    <div class="alert alert-warning text-center shadow-sm mt-4">No ready jobs found.</div>
  {% endfor %}
  {% if groupx %}
    <div class="card my-3 shadow-sm border-0">
      <!-- Card Header -->
      <div class="card-header text-white fw-bold d-flex justify-content-between align-items-center" style="background-color: #ff0000ff;">
        <span>Wrong postcodes group ‚Äî {{ groupx.jobs.all|length }} job{{ groupx.jobs|length|pluralize }}</span>
      </div>

      <!-- Job List -->
      <ul class="list-group list-group-flush">
        {% for job in groupx.jobs.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {{ job.id }}
              <a href="{% url 'update_job' job.job_id %}" class="fw-bold text-decoration-none text-primary">{{ job.job_id }}</a>
              <span class="text-muted">‚Äî {{ job.address }}-{{ job.post_code }}</span>
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}


  
<script> 
  

// Scroll to job on load if hash exists
window.addEventListener("load", function () {
if (window.location.hash) {

const el = document.querySelector(window.location.hash);
if (el) {
el.scrollIntoView({ behavior: "smooth", block: "center" });
}
}
});

// Preserve hash across pagination
document.querySelectorAll(".pagination a").forEach(link => {
link.addEventListener("click", function() {
if (window.location.hash) {
this.href = this.href + window.location.hash;
}
});
});
</script> 
<script>
window.addEventListener("load", function () {
let job_id = localStorage.getItem('lastJob');
if (!job_id) return;

let card = document.getElementById(job_id);

if (card) {
card.style.backgroundColor = '#1482b5ff';

card.style.transition = 'background-color 3s ease ';
card.style.padding = '0.5rem 0.5rem';
card.scrollIntoView({ behavior: "smooth", block: "center" });
localStorage.removeItem('lastJob');
return;
}

// If not found, go to next page if available
const nextPageLink = document.querySelector('.pagination .page-link[title="Next"]');
if (nextPageLink) {
// Preserve other query params and hash
nextPageLink.href += '';
nextPageLink.click();
} else {
// Job not found, cleanup
localStorage.removeItem('lastJob');
}
});
</script>


{% endblock %}
