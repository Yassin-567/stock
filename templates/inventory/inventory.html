{% extends 'inventory/base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Inventory - Stocky{% endblock %}
{% block body %}
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}
<br> 
<form method="get" class="row row-cols-lg-auto g-2 align-items-center mb-3 ">
  <!-- Status -->
  <div class="col-auto">
    <label for="status" class="form-label mb-0 me-1">Status</label>
    <select name="status" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
      <option value="all" {% if not status or status == 'all' %}selected{% endif %}>All jobs</option>
      <option value="ready" {% if status == 'ready' %}selected{% endif %}>Ready</option>
      <option value="paused" {% if status == 'paused' %}selected{% endif %}>Paused</option>
      <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
      <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
      <option value="quoted" {% if status == 'quoted' %}selected{% endif %}>Quoted</option>
    </select>
  </div>

  <!-- Date -->
  <div class="col-auto">
    <label for="date" class="form-label mb-0 me-1">Visit date</label>
    <input type="text" id="date" name="date"
      class="form-control form-control-sm w-auto flatpickr_date"
      placeholder="Select date"
      value="{{ request.GET.date }}" />
  </div>

  <!-- Search -->
  <div class="col-auto  ">
    <label for="search" class="form-label mb-0 me-1">Search</label>
    <input type="search" name="q"
      class="form-control form-control-sm w-auto"
      placeholder="Search jobs"
      aria-label="Search"
      value="{{ request.GET.q }}" />
  </div>
  <div class="col-auto">
    <label for="date-range" >Job added date</label>
    <div name="date-range" class="d-flex align-items-center " style="border-style: ridge; padding:2px; border-radius: 10px;">
    <label for="added_from_date" class="form-label mb-0 me-1">From</label>
    <input type="text" id="added_from_date" name="added_from_date"
      class="form-control form-control-sm w-auto flatpickr_date"
      placeholder="Select date"
      value="{{ request.GET.added_from_date }}" />

          <label for="added_to_date" class="form-label mb-0 me-1">To</label>
    <input type="text" id="added_to_date" name="added_to_date"
      class="form-control form-control-sm w-auto flatpickr_date"
      placeholder="Select date"
      value="{{ request.GET.added_to_date }}" />
</div>
  </div>

  <!-- Button -->
  <div class="col-auto  ">
    <label class="form-label mb-0 me-1"></label><br>
    <button type="submit" class="btn btn-sm btn-primary">
      <i class="bi bi-funnel"></i> Apply
    </button>
  </div>
</form>
{% comment %} <form method="get" class="mb-3">{% if request.GET.q %}
        <input type="hidden" name="q" value="{{ request.GET.q }}" />
      {% endif %}
<label for="status" class="form-label ">Filter by job Status:</label>
<select name="status" onchange="this.form.submit()" class="form-select w-auto d-inline">
<option value="all"  {% if not status or status == 'all' %}selected{% endif %}>All jobs</option>
<option value="ready" {% if status == 'ready' %}selected{% endif %}>Ready</option>
<option value="paused" {% if status == 'paused' %}selected{% endif %}>Paused</option>
<option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
<option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
<option value="quoted" {% if status == 'quoted' %}selected{% endif %}>Quoted</option>
</select>

<!-- Date Filter -->
<label for="date" class="form-label mb-0">Filter by Date:</label>
<input type="text" id="date" name="date" class="form-control flatpickr_date w-auto d-inline" placeholder="Select date" value="{{ request.GET.date }}" />
<button type="submit"  class="btn btn-primary btn-sm">Apply</button>   
</form>
<form class="d-flex " role="search" action="" method="get">
  <input class="form-control me-2" type="search" name="q" placeholder="Search jobs" aria-label="Search" value="{{ request.GET.q }}" />
  {% if request.GET.date %}
    <input type="hidden" name="date" value="{{ request.GET.date }}" />
  {% endif %}
  {% if request.GET.status %}
    <input type="hidden" name="status" value="{{ request.GET.status }}" />
  {% endif %}
  <button class=" btn btn-secondary">Search</button>
</form>{% endcomment %}
<form method="post" class="row row-cols-lg-auto g-2 align-items-center mb-3"> 
{% csrf_token %}
<label for="date" class="form-label mb-0 ">Notify engineers:</label>
<input type="text" id="date" name="date" class="form-control flatpickr_date w-auto d-inline " placeholder="Select date" value="{{ request.POST.date }}" />
<button type="submit" name="send_emails" class="btn btn-primary btn-sm col-auto">Send emails</button>
</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
flatpickr('.flatpickr_date', {
enableTime: false,
dateFormat: 'Y-m-d',
altInput: true,
altFormat: 'F j, Y'
})
</script>

<a class="btn btn-primary px-4 me-3" href="{% url 'create_job' %}">Add job</a>
<br><br>
{% if rjobs %}
{% for job in rjobs %}

<div id="{{ job.job_id }}" class="card mb-4 shadow-sm">
<div class="card-body job-card">
<div  class="row">

<!-- Left Side: Job Info -->
<div class="col-md-5">
<h2>
  {{job.birthday}}
    Job ID: 
    <a href="{% url 'update_job' job.job_id %}"  
      onclick="localStorage.setItem('lastJob',{{job.job_id}});">{{ job.job_id }}</a> -
    <span class="badge status-{{ job.status }}">{{ job.get_status_display }}
      {% if job.quoted %}
<span class="quote-box">Quoted: $<span class="quote-value">{{ job.quotation }}</span>

  {% if job.quote_accepted %}
    <span class="quote-accepted">Quote accepted</span>
  {% elif job.quote_declined %}
    <span class="quote-declined">Quote declined</span>
  {% endif %}
  {% endif %}
  </span>
  </h2>

  <div class="job-info">
{% if job.birthday|days_float < 7 %}
<span style="
    display: inline-block;
    color: #fff;
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    margin-bottom: 5px;
">
    üÜï New Job ‚Ä¢ Age: {{ job.birthday|timesince }}
</span>
{% endif %}

{% if job.birthday|days_float >= 7 %}
<span style="
    display: inline-block;
    color: #ffe600;
    background: #222;
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
     margin-bottom: 5px;
">
    ‚ö†Ô∏è Old Job ‚Ä¢ Age: {{ job.birthday|timesince }}
</span>
{% endif %}

    
    <p><strong>Address:</strong> {{ job.address }}</p>
    <p><strong>Parent Account:</strong> {{ job.parent_account }}</p>
    <p>
    <p><strong>Date:</strong> {{ job.date }}</p>
  <p><strong>From:</strong>{{job.from_time}} <strong>To:</strong>{{job.to_time}}</p>
    <p><strong>Assigned to:</strong> {{ job.engineer}}</p>
  </p>
    <p>
      <strong>Unique items:</strong> {{ job.items.count }},
      <strong>Total required:</strong> {{ job|total_quantity }},
      <strong>Arrived:</strong> {{ job|total_arrived_quantity }}
    </p>
</div>

<!-- Items Section -->
<div class="mt-3">
<button class="btn btn-toggle mb-2" onclick="toggleItems(this)">Show Items</button>
<ul class="job-items list-unstyled ms-3" style="display: none;">
  {% for jobitem in job.items.all %}
    <li>
      <a onclick="localStorage.setItem('lastJob',{{jobitem.job.job_id}});" href="{% url 'update_item' jobitem.id %}">{{ jobitem.name }}</a> 
      - Part Number: {{ jobitem.part_number }} 
      - Price: ${{ jobitem.price }}

      {% if jobitem.arrived and not jobitem.is_used and not jobitem.from_warehouse %}
        <span class="tag arrived">Arrived</span>
{% elif jobitem.ordered and not jobitem.from_warehouse and not jobitem.is_used %}
  <span class="tag ordered">Ordered</span>
{% elif jobitem.was_for_job and jobitem.from_warehouse and not jobitem.is_used %}
  <span class="tag was-for-job">was for job {{ jobitem.was_for_job }}</span>
{% elif jobitem.from_warehouse and not jobitem.is_used %}
  <span class="tag from-warehouse">From warehouse</span>
{% elif jobitem.is_used %}
  <span class="tag used">Used</span>
{% else %}
  <span class="tag not-ordered">Not ordered</span>
      {% endif %}

      {% if jobitem.was_it_used and job.status != 'completed' %}
        <small>The job was reopened, do you still have the part?</small>
        <form action="{% url 'inventory' jobitem.id %}" method="POST" class="inline-form">
          {% csrf_token %}
          <button name="reset_was_it_used" type="submit" class="btn btn-danger">It's not used</button>
        </form>
      {% endif %}
    </li>
  {% empty %}
    <li>No items associated with this job.</li>
  {% endfor %}
</ul>
</div>
</div>

<!-- Middle Column: Comments -->
<div class="col-md-4 text-center">
<div class="p-2 border-start border-end" style="min-height:100%;">
<h5>Comments</h5>

<div class="comments-container">
{% for comment in job.comments.all %}
<div class="comment-card">
<span>Added by {{ comment.added_by.username }}</span>
<p style="color: rgba(190, 21, 236, 0.79);">{{ comment.comment }}</p>
<span>{{ comment.added_date }}</span>
</div>
{% empty %}
<p>No comments available.</p>
{% endfor %}
</div>
</div>
</div>

<!-- Right Side: Job History -->
 <div class="col-md-3 text-center">
<div class="p-2 border-start" style="min-height:100%;">
<h5>Job history</h5>
<div class="history-container">
{% if job.history %}
<div class="row g-3">
{% for h in job.history.all %}
  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <h5 class="card-title">{{ h.content_type.model|capfirst }}</h5>
        <small class="text-muted">
          <a href="{{ h.content_object|get_link }}">{{ h.content_object }}</a>
        </small>
        <h6 class="card-subtitle mb-2 text-muted">
          {% if h.created %}Created{% else %}Changed{% endif %}
          by <strong>{{ h.user }}</strong><br>
          <small>At: {{ h.changed_at|date:'Y-m-d H:i' }}</small>
        </h6>
        {% if not h.created %}
          <p class="mb-1"><strong>Field:</strong> {{ h.field }}</p>
          <p class="text-danger mb-1"><strong>Old:</strong> {{ h.old_value|default:"(empty)" }}</p>
          <p class="text-success mb-1"><strong>New:</strong> {{ h.new_value|default:"(empty)" }}</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endfor %}
</div>
{% else %}
<div class="alert alert-info">No changes found in history.</div>
{% endif %}
 
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
{% endfor %}

<div class="d-flex justify-content-center mt-4">
<nav>
<ul class="pagination pagination-sm mb-0">
{% if page_obj.has_previous %}
  <li class="page-item">
    <a class="page-link"
      href="?page=1{{querystring}}"
      title="First">&laquo;</a>
  </li>
  <li class="page-item">
    <a class="page-link"
      href="?page={{ page_obj.previous_page_number }}{{querystring}}"
      title="Previous">&lsaquo;</a>
  </li>
  {% else %}
  <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
  <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
{% endif %}

<li class="page-item active"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>

{% if page_obj.has_next %}
  <li class="page-item">
    <a class="page-link"
      href="?page={{ page_obj.next_page_number }}{{querystring}}"
      title="Next">&rsaquo;</a>
  </li>
  <li class="page-item">
    <a class="page-link"
      href="?page={{ page_obj.paginator.num_pages }}{{querystring}}"
      title="Last">&raquo;</a>
  </li>
{% else %}
  <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
  <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
{% endif %}
</ul>
</nav>
</div>
{% elif status %}
<h3>No {{ status }} jobs</h3>
{% endif %}
<link rel="stylesheet" href="{% static 'css/style.css' %}" />
<style>
.job-card { background: #f8f9fa; padding: 1rem 1.5rem; border-radius: 10px; }
.job-hint.green { color: rgb(0, 129, 43); font-weight: 500; }
.job-hint.yellow { color: orange; font-weight: 500; }
.badge { display: inline-block; padding: 4px 10px; font-size: 1rem; font-weight: 500; color: white; border-radius: 5px; text-transform: capitalize; overflow-x: hidden; }
.status-ready { background-color: rgb(0, 129, 43); }
.status-paused { background-color: rgb(0, 98, 255); }
.status-cancelled { background-color: rgb(167, 30, 12); }
.status-completed { background-color: rgb(131, 25, 108); }
.status-quoted { background-color: rgb(228, 216, 51); color: #000; }
.tag { padding: 2px 8px; border-radius: 15px; font-size: 0.9rem; margin-left: 10px; display: inline-block; }
.tag.arrived { background: #11ff09; color: #000; }
.tag.ordered { background: #e4d833; color: #000; }
.tag.was-for-job { background: #77a3c0; color: #000; }
.tag.from-warehouse { background: #9d77c0; color: #000; }
.tag.used { background: #360808; color: #fff; }
.tag.not-ordered { background: #ff6262; color: #000; }
.tag.used-info { background-color: rgba(182, 182, 182, 0.79); color: #333; }
.btn-toggle { background-color: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 6px; margin-top: 10px; cursor: pointer; }
.btn-toggle:hover { background-color: #0056b3; }
.inline-form { display: inline; }
 .quote-box {
      display: inline-block;
      padding: 5px 10px;
      font-size: 1.2rem;
      font-weight: normal;
      color: #fff;
      background-color: rgba(153, 165, 48, 1);
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
.quote-accepted { background-color: #00a767ff; color: #ffffffff; padding: 4px 10px; font-size: 1rem; font-weight: 500; border-radius: 5px; text-transform: capitalize; margin-left: 10px; }
.quote-declined { background-color: #6e003dff; color: #fcfcfcff; padding: 4px 10px; font-size: 1rem; font-weight: 500; border-radius: 5px; text-transform: capitalize; margin-left: 10px; }

.history-container {
max-height: 350px;   /* limit the height */
overflow-y: auto;    /* enable vertical scrolling */
border-radius: 5px;
padding-right: 5px;  /* avoid scrollbar overlap */
background-color: #dbe3ebff;
overflow-x: none;
}
.history-container .card-body {
background-color: #dbe3ebff;
padding: 10px;
border-radius: 5px;
text-align: center;
}
/* Force wrapping inside job ID header */
.job-card h2 {
display: flex;
flex-wrap: wrap;   /* allow wrapping */
align-items: center;
gap: 8px;          /* spacing between items */
word-break: break-word;
}

/* Prevent badges/quote boxes from overflowing */
.job-card .badge,
 {
max-width: 100%;
white-space: normal;  /* allow text to wrap */
word-wrap: break-word;
}

.comments-container {
  background-color: #d2dce2ff;
max-height: 350px;  /* limit height */
overflow-y: scroll;   /* add scrollbar if too many comments */
border-radius: 5px;
padding: 5px;


}


.job-info :hover {
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
transform: translateY(-5px);
transition: all 0.1s ease;
background-color: #feffe0ff;

}
.comments-container :hover{

box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
transform: translateY(-5px);
transition: all 0.1s ease;
background-color: #feffe0ff;


}


</style>

<script> 
  
function toggleItems(button) {
const ul = button.nextElementSibling;
if (ul.style.display === 'none') {
ul.style.display = 'block';
button.textContent = 'Hide Items';
} else {
ul.style.display = 'none';
button.textContent = 'Show Items';
}
}

// Scroll to job on load if hash exists
window.addEventListener("load", function () {
if (window.location.hash) {
const el = document.querySelector(window.location.hash);
if (el) {
el.scrollIntoView({ behavior: "smooth", block: "center" });
}
}
});

// Preserve hash across pagination
document.querySelectorAll(".pagination a").forEach(link => {
link.addEventListener("click", function() {
if (window.location.hash) {
this.href = this.href + window.location.hash;
}
});
});
</script> 
<script>
window.addEventListener("load", function () {
let job_id = localStorage.getItem('lastJob');
if (!job_id) return;

let card = document.getElementById(job_id);

if (card) {
card.style.backgroundColor = '#0c3649ff';

card.style.transition = 'background-color 3s ease ';
card.style.padding = '0.5rem 0.5rem';
card.scrollIntoView({ behavior: "smooth", block: "center" });
localStorage.removeItem('lastJob');
return;
}

// If not found, go to next page if available
const nextPageLink = document.querySelector('.pagination .page-link[title="Next"]');
if (nextPageLink) {
// Preserve other query params and hash
nextPageLink.href += '';
nextPageLink.click();
} else {
// Job not found, cleanup
localStorage.removeItem('lastJob');
}
});
</script>

{% endblock %}
