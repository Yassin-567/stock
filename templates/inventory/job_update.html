{% extends 'inventory/base.html' %}
{% load static %}
{% load custom_tags %}
{% block body %}
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}" style="z-index: 999;">{{ message }}</div>
    {% endfor %}
  {% endif %}
  <h2 class="job-header">
    <!-- Job ID -->
    <span>
      Job ID:
      <span class="job-id">{{ job.job_id }}</span>
    </span>

    <!-- Parts count -->
    <span class="parts-count">Parts count: {{ items_count }}</span>


    <!-- Quotation -->
    {% if job.quoted %}
      <span class="quote-box">
        Quoted: $<span class="quote-value">{{ job.quotation }}</span>

        {% if job.quote_accepted %}
          <span class="quote-status accepted">Quote accepted</span>
        {% elif job.quote_declined %}
          <span class="quote-status declined">Quote declined</span>
        {% endif %}
        {% if job.status != 'completed' and job.status != 'cancelled' %}
        
<form action="" method="post" class="quote-actions">
        {% csrf_token %}
        {% comment %} <label for="quote_status"  class="form-label mb-0 me-1">Quotation status:</label> {% endcomment %}
        <select  name="quote_status" onchange="this.form.submit()" id="">
          <option value="quote_unknown" {% if job.quote and not job.quote_accepted and job.quote_declined == False %}selected{% endif %}>Waiting</option>
          <option value="quote_accepted" {% if job.quote_accepted %}selected{% endif %}>Quote accepted</option>
          <option value="quote_declined" {% if job.quote_declined %}selected{% endif %}>Quote declined</option>
        </select> 
      </form>
      
      {% endif %}
        <!-- Action buttons -->
      </span>
     


    {% endif %}

  <form action="" method="post">
    {% csrf_token %}
    
    <!-- Always tell the view this toggle refers to on_hold -->
    <input type="hidden" name="hold" value="1">

    {% if job.on_hold %}
        <!-- If currently ON, send a flag to tell the view to turn it off -->
        <input type="hidden" name="on_hold" value="1">
    {% endif %}

    <div class="form-check form-switch">
        <input 
            class="form-check-input" 
            type="checkbox" 
            id="on_hold"
            {% if job.on_hold %}checked{% endif %}
            onchange="this.form.submit()">
        <label class="form-check-label" for="on_hold">
            ✋ Put on hold
        </label>
    </div>
</form>

  </h2>

  <style>
    .job-header {
      margin-bottom: 20px;
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .job-id {
      display: inline-block;
      padding: 5px 10px;
      margin-left: 10px;
      font-size: 1.2rem;
      font-weight: normal;
      color: #333;
      background-color: rgba(182, 182, 182, 0.79);
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .parts-count {
      display: inline-block;
      padding: 5px 10px;
      font-size: 1.2rem;
      font-weight: normal;
      color: #333;
      background-color: rgb(182, 182, 182);
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .quote-box {
      display: inline-block;
      padding: 5px 10px;
      font-size: 1.2rem;
      font-weight: normal;
      color: #fff;
      background-color: rgba(153, 165, 48, 1);
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .quote-value {
      color: #fff;
    }
    
    .quote-status {
      display: inline-block;
      padding: 1px 4px;
      font-size: 1rem;
      font-weight: normal;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-left: 8px;
    }
    
    .quote-status.accepted {
      color: #333;
      background-color: rgba(6, 255, 89, 1);
    }
    
    .quote-status.declined {
      color: #fff;
      background-color: rgba(173, 0, 58, 1);
    }
    
    /* ✅ buttons in next row */
    .quote-actions {
      display: block; /* Forces new line */
      margin-top: 10px; /* spacing from quotation */
    }
    
    .quote-actions button {
      margin-right: 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .quote-actions button[name='quote_accepted'] {
      background-color: rgba(6, 255, 89, 1);
      color: #333;
    }
    
    .quote-actions button[name='quote_declined'] {
      background-color: rgba(173, 0, 58, 1);
      color: #fff;
    }
  </style>
  <h3>Unique items= {{ job.items.count }} Total required items={{ job|total_quantity }} Arrived={{ job|total_arrived_quantity }} 
   <form action="" method="post">
    {% csrf_token %}
    
    <!-- This always tells the view that this toggle is about parts attention -->
    <input type="hidden" name="parts_attention" value="1">

    {% if job.parts_need_attention %}
        <!-- If already True, send a signal meaning 'turn it off' -->
        <input type="hidden" name="parts_dont_need_attention" value="1">
    {% endif %}

    <div class="form-check form-switch">
        <input 
            class="form-check-input" 
            type="checkbox" 
            id="parts_need_attention"
            {% if job.parts_need_attention %}checked{% endif %}
            onchange="this.form.submit()">
        <label class="form-check-label" style="color: #86372dff;" for="parts_need_attention">
            Parts need attention
        </label>
    </div>
</form>

    
    </h3>
 
  {% if job.status == 'paused' or job.status == 'ready' %}
    <h4><a href="{% url 'item_add' job.job_id %}">Add item</a></h4>
  {% endif %}
  
  <section class="form-section">
    
    <form action="" method="POST" enctype="multipart/form-data" class="form-container">
      {% csrf_token %}

      <div id="id_quotation">
        <label for="quotation" style="color: rgb(0, 124, 206);">Add price quotation</label>
        <input type="floatformat" step="0.01" name="quotation" style="background-color: rgb(56, 167, 12);" />
      </div>

      <br />
   
      
      
      <div class="form-group">{{ form.as_p }}</div>

      <div class="form-group">
        <button type="submit" name="save" class="btn-submit">Save</button>
        {% if job_status == 'ready' %}
          <button type="submit" name="send_email" class="btn-submit">Send email</button><span><h6>Send a list with the required parts for the engineer</h6></span>
        {% endif %}
      </div>

      <form method="POST">
        {% csrf_token %}
        <section class="form-section">
          <div class="form-group">{{ comments_form.as_p }}</div>
          <div>
            <button name="add_comment" type="submit" class="btn-submit">Add comment</button>
          </div>
        </section>
      </form>
    </form>
  </section>
<style>
  .tag { padding: 2px 8px; border-radius: 15px; font-size: 0.9rem; margin-left: 10px; display: inline-block; }
.tag.arrived { background: #11ff09; color: #000; }
.tag.ordered { background: #e4d833; color: #000; }
.tag.was-for-job { background: #77a3c0; color: #000; }
.tag.from-warehouse { background: #9d77c0; color: #000; }
.tag.used { background: #360808; color: #fff; }
.tag.not-ordered { background: #ff6262; color: #000; }
.tag.used-info { background-color: rgba(182, 182, 182, 0.79); color: #333; }

</style>
  <ol>
    {% for jobitem in job.items.all %}
      <li>
        <a href="{% url 'update_item' jobitem.id %}">{{ jobitem.name }}</a> - Part Number: {{ jobitem.part_number }} - Price: ${{ jobitem.price }} - Qty: {{ jobitem.job_quantity }}
      {% if jobitem.arrived and not jobitem.is_used and not jobitem.from_warehouse %}
        <span class="tag arrived">Arrived</span>
{% elif jobitem.ordered and not jobitem.from_warehouse and not jobitem.is_used %}
  <span class="tag ordered">Ordered</span>
{% elif jobitem.was_for_job and jobitem.from_warehouse and not jobitem.is_used %}
  <span class="tag was-for-job">was for job {{ jobitem.was_for_job }}</span>
{% elif jobitem.from_warehouse and not jobitem.is_used %}
  <span class="tag from-warehouse">From warehouse</span>
{% elif jobitem.is_used %}
  <span class="tag used">Used</span>
{% else %}

  <span class="tag not-ordered">Not ordered</span>
        {% endif %}
        {% if jobitem.was_it_used and job.status != 'completed' and job.status != 'cancelled' %}
          <small>The job was reopened, do you still have the part?</small> <form action="{% url 'inventory' jobitem.id %}" method="POST">
            {% csrf_token %}
            <small><input type="hidden" name="coming_from_job" value="coming_from_job" /><button name="reset_was_it_used" type="submit" class="btn btn-danger">It's not used</button></small>
          </form>
        {% endif %}

        {% if jobitem.item.is_used %}
          <span style="
        display: inline-block;
padding: 1px 10px;
margin-left: 10px;
font-size: 1.2rem;
font-weight: normal;
color: #333;
background-color: rgba(182, 182, 182, 0.79);
border: 1px solid #ddd;
border-radius: 10px;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  ">Used</span>
          {{ item.notes }}
        {% endif %}
      </li>
    {% empty %}
      <li>No items associated with this job.</li>
    {% endfor %}
  </ol>
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <section>
    <h3>Comments</h3>
    <div class="comments-container">
      {% for comment in comments %}
        <div class="comment-card">
          <span>Added by {{ comment.added_by.username }}</span>
          <p style="color: rgba(117, 58, 255, 0.79);">{{ comment }}</p>
          <span>{{ comment.added_date }}</span>
        </div>
      {% empty %}
        <p>No comments available.</p>
      {% endfor %}
    </div>
  </section>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const statusField = document.getElementById('id_status')
      const quotingPriceGroup = document.getElementById('id_quotation')
      function toggleQuotingPrice() {
        if (!statusField || !quotingPriceGroup) return
        const value = statusField.value.toLowerCase()
        if (value === 'quoted' || value === 'waiting') {
          quotingPriceGroup.style.display = ''
        } else {
          quotingPriceGroup.style.display = 'none'
          const input = quotingPriceGroup.querySelector('input')
          if (input) input.value = ''
        }
      }
      if (statusField && quotingPriceGroup) {
        toggleQuotingPrice()
        statusField.addEventListener('change', toggleQuotingPrice)
      }
    })
  </script>
  <script>
    flatpickr('.flatpickr_date', {
      enableTime: false,
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'F j, Y'
    })
    
    flatpickr('.flatpickr_from_time', {
      enableTime: true,
      noCalendar: true,
      dateFormat: 'H:i',
      altInput: true,
      altFormat: 'h:i K',
      allowInput: true,
      onReady: function (selectedDates, dateStr, instance) {
        instance._input.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace' || e.key === 'Delete') {
            instance.clear()
          }
        })
      }
    })
    
    flatpickr('.flatpickr_to_time', {
      enableTime: true,
      noCalendar: true,
      dateFormat: 'H:i',
      altInput: true,
      altFormat: 'h:i K',
      allowInput: true, // ⬅️ Allows manual editing (including clearing)
      onReady: function (selectedDates, dateStr, instance) {
        // ⬅️ Enable clear when backspacing or deleting
        instance._input.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace' || e.key === 'Delete') {
            instance.clear()
          }
        })
      }
    })
  </script>
{% endblock %}
