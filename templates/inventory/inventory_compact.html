  {% extends 'inventory/base.html' %}
  {% load static %}
  {% load custom_tags %}

  {% block title %}
    Stocky
  {% endblock %}
  {% block body %}
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
    <!-- Full Form Layout -->
<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap">

  <!-- Filtering Form -->
  <form method="get"
        class="row row-cols-lg-auto g-2 align-items-center mb-0"
        style="
          
          width: fit-content;
          padding: 1px 12px;
          background: linear-gradient(90deg, #4f5c5bff, #343d3cff, #4f5c5bff);
          border-radius: 10px;
          display: flex;
          align-items: center;
          gap: 1px;
          flex-wrap: wrap;
        
        ">

    <!-- Status -->
    <div class="col-auto">
      <label for="status" class="form-label mb-0 me-1 text-white">Status</label>
      <select name="status" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
        <option value="all" {% if not status or status == 'all' %}selected{% endif %}>All jobs</option>
        <option value="ready" {% if status == 'ready' %}selected{% endif %}>Ready</option>
        <option value="paused" {% if status == 'paused' %}selected{% endif %}>Paused</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
        <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
        <option value="quoted" {% if status == 'quoted' %}selected{% endif %}>Quoted</option>
        <option value="on_hold" {% if status == 'on_hold' %}selected{% endif %}>On hold✋</option>
      </select>
    </div>

    <!-- Quotation -->
    <div class="col-auto">
      <label for="quotation_status" class="form-label mb-0 me-1 text-white">Quotation</label>
      <select name="quotation_status" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
        <option value="all" {% if not quotation_status or quotation_status == 'all' %}selected{% endif %}>All</option>
        <option value="accepted" {% if quotation_status == 'accepted' %}selected{% endif %}>Accepted</option>
        <option value="declined" {% if quotation_status == 'declined' %}selected{% endif %}>Declined</option>
        <option value="waiting" {% if quotation_status == 'waiting' %}selected{% endif %}>Waiting</option>
      </select>
    </div>

    <!-- Age -->
    <div class="col-auto">
      <label for="age" class="form-label mb-0 me-1 text-white">Age</label>
      <select name="age" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
        <option value="all" {% if not age or age == 'all' %}selected{% endif %}>All</option>
        <option value="new" {% if age == 'new' %}selected{% endif %}>New jobs</option>
        <option value="old" {% if age == 'old' %}selected{% endif %}>Old jobs</option>
      </select>
    </div>

    <!-- Visit Date -->
    <div class="col-auto">
      <label for="date" class="form-label mb-0 me-1 text-white">Visit date</label>
      <input type="text" id="date" name="date"
             class="form-control form-control-sm w-auto flatpickr_date"
             placeholder="Select date"
             value="{{ request.GET.date }}" />
    </div>

    <!-- Search -->
    <div class="col-auto">
      <label for="search" class="form-label mb-0 me-1 text-white">Search</label>
      <input type="search" name="q"
             class="form-control form-control-sm w-auto"
             placeholder="Search jobs"
             aria-label="Search"
             value="{{ request.GET.q }}" />
    </div>

    <!-- Job Birthday -->
    <div class="col-auto">
      <label for="date-range" class="form-label mb-0 text-white">Job birthday</label>
      <div name="date-range"
           class="d-flex align-items-center border border-light p-2 rounded-3"
           style="gap: 6px;">
        <label for="added_from_date" class="form-label mb-0 me-1 text-white">From</label>
        <input type="text" id="added_from_date" name="added_from_date"
               class="form-control form-control-sm w-auto flatpickr_date"
               placeholder="Select date"
               value="{{ request.GET.added_from_date }}" />

        <label for="added_to_date" class="form-label mb-0 me-1 text-white">To</label>
        <input type="text" id="added_to_date" name="added_to_date"
               class="form-control form-control-sm w-auto flatpickr_date"
               placeholder="Select date"
               value="{{ request.GET.added_to_date }}" />
      </div>
    </div>

    <!-- Apply Button -->
    <div class="col-auto">
      <button type="submit" class="btn btn-sm btn-primary mt-3">
        <i class="bi bi-funnel"></i> Apply
      </button>
    </div>
  </form>

  <!-- Sync Jobs Button -->
  <a class="btn btn-success btn-sm px-3 py-1 fw-bold shadow-sm mt-2 mt-lg-0"
     style="font-size:0.95rem; border-radius:20px;"
     id="sync"
     href="{% url 'get_jobs_from_sf' %}">
    <i class="bi bi-arrow-repeat"></i> Sync jobs
  </a>
</div>



  <script>
    const form = document.getElementById('sync')
    const yesBtn = document.getElementById('sync')
    
    form.addEventListener('click', function () {
      // Show spinner
      yesBtn.innerHTML = `<span class="spinner-border spinner-border-sm " role="status" aria-hidden="true"></span> Syncing`
    yesBtn.style= "margin-left: 70px;"
      // Prevent resending "choice=yes" after first submit
      setTimeout(() => {
        yesBtn.removeAttribute('name')
      }, 0)
    
      // Block left mouse clicks on the whole document
      document.addEventListener('click', blockLeftClick, true)
    })
    
    function blockLeftClick(e) {
      if (e.button === 0) {
        // 0 = left button
        e.stopPropagation()
        e.preventDefault()
      }
    }
  </script>
<form method="get" class="row row-cols-lg-auto g-2 align-items-center mb-3"> 

<label for="send_emails_date" class="form-label mb-0 ">Notify engineers:</label>
<div style="padding:2px; background: linear-gradient(90deg, #2980B9, #6DD5FA, #ff5353ff); border-radius: 8px; display:inline-block; width: fit-content;">
  <input type="text" 
         id="date" 
         name="send_emails_date" 
         class="form-control flatpickr_date w-auto d-inline" 
         style="border: 1px solid transparent; border-radius:6px; outline:none; background:white;" 
         placeholder="Select date" 
         value="{{ request.GET.send_emails_date }}" />

<button type="submit" name="send_emails" class="btn btn-primary btn-sm col-auto" style="background: linear-gradient( #5363f5ff , #00dbde);">Send emails</button>
</div></form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

    {% if rjobs %}
      <div  class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>Job ID   
</th>
              <th>Status</th>
              <th>Quotation</th>
              <th>Address</th>
              <th>Date</th>
              <th>Time</th>
              
              <th>Engineer</th>
              <th>Items</th>
            </tr>
          </thead>
          <tbody>
            {% for job in rjobs %}
            
              <tr id="{{ job.job_id }}" onclick="localStorage.setItem('lastJob',{{ job.job_id }});" >
                <td>
                  <a href="{% url 'update_job' job.job_id %}" onclick="localStorage.setItem('lastJob',{{ job.job_id }});">{{ job.job_id }}</a>
                  {% if job.on_hold %}✋{% endif %}
                </td>
                <td>
                  <span class="badge status-{{ job.status }}">{{ job.get_status_display }}</span>
                </td>
                <td>
{% if job.quoted %}

                  <form action="" method="post"> 
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{job.id}}" id="">
                    ${{job.quotation}}
                <select name="change_quote_status"
        onchange="updateSelectColor(this); this.form.submit();"
        class="quote-select"
        id="quote-select-{{ job.id }}">
  <option value="accepted" {% if job.quote_accepted and not job.quote_declined %}selected{% endif %}>Accepted</option>
  <option value="declined" {% if job.quote_declined and not job.quote_accepted %}selected{% endif %}>Declined</option>
  <option value="waiting" {% if not job.quote_declined and not job.quote_accepted %}selected{% endif %}>Waiting</option>
</select>



                    </select>
                    
                  </form>{% endif %}
                  
                </td>
                <td>{{ job.address }} </td>
              
                <form action="" method="post" name="change_datetime" onclick="this.form.submit();">
                  {% csrf_token %}
<input type="hidden" name="job_id" value="{{job.id}}" id="">
                <td>
                        <input type="text" id="added_from_date" name="change_from_date"
                    class="form-control form-control-sm w-auto flatpickr_date"
                    placeholder="{{ job.date|default:"Select date" }}"
                    value="{{ job.date|date:'Y-m-d' }}" />
    
             </td>

<td class="align-top">
  <div class="d-flex flex-column gap-1">
    <input type="text" id="change_from_time" name="change_from_time"
           class="form-control form-control-sm flatpickr_time"
           style="width: 120px;"
           placeholder="From"
           value="{{ job.from_time|time:'H:i' }}" />

    <input type="text" id="change_to_time" name="change_to_time"
           class="form-control form-control-sm flatpickr_time"
           style="width: 120px;"
           placeholder="To"
           value="{{ job.to_time|time:'H:i' }}" />

    <button type="submit" class="btn btn-sm btn-primary mt-1 w-100">
      <i class="bi bi-funnel"></i> Apply
    </button>

    {% if form_job_id == job.job_id %}
      <div class="text-danger small mt-1">
        {{ form.to_time.errors }}
      </div>
    {% endif %}
  </div>
</td>

   
  
  </form>



                <td >
                  <form action="" method="post">
                    {% csrf_token %}
                              <input type="hidden" name="job_id" value="{{job.id}}" id="">
            
          <select name="change_engineer" id="" onchange=" this.form.submit();">

                      <option value="" {% if not engineer%} selected {% endif %}>-</option>
                    {% for eng in request.user.company.engineers_company.all %}
                    
                    <option value="{{eng.id}}" {% if eng.id == job.engineer.id %}selected{% endif %}>{{eng.name}}</option>
                    {% endfor %}


</select>

                  </form>



                </td>
                <td style="width: auto;">
                  {% if job.items.all %}
                  {{ job|total_quantity }} req items, Arrived: {{ job|total_arrived_quantity }}
                  <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleItemsRow(this)">Show Items</button>
                  <ul class="job-items list-unstyled ms-2" style="display:none;">
                   {% for item in job.items.all %}
      <div>
        <a href="{% url 'update_item' item.id %}">{{ item.name }}</a> - {{ item.part_number }} - ${{ item.price }}
      </div>
    {% empty %}
      <div>--</div>
    {% endfor %}{% else %}No items{% endif %}

                  </ul>
                </td>
               
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No jobs found.</p>
    {% endif %}


<div class="d-flex justify-content-center mt-4">
<nav>
<ul class="pagination pagination-sm mb-0">
{% if page_obj.has_previous %}
  <li class="page-item">
    <a class="page-link"
      href="?page=1{{querystring}}"
      title="First">&laquo;</a>
  </li>
  <li class="page-item">
    <a class="page-link"
      href="?page={{ page_obj.previous_page_number }}{{querystring}}"
      title="Previous">&lsaquo;</a>
  </li>
  {% else %}
  <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
  <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
{% endif %}

<li class="page-item active"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>

{% if page_obj.has_next %}
  <li class="page-item">
    <a class="page-link"
      href="?page={{ page_obj.next_page_number }}{{querystring}}"
      title="Next">&rsaquo;</a>
  </li>
  <li class="page-item">
    <a class="page-link"
      href="?page={{ page_obj.paginator.num_pages }}{{querystring}}"
      title="Last">&raquo;</a>
  </li>
{% else %}
  <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
  <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
{% endif %}
</ul>
</nav>
</div>
<style>
.quote-select {
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 500;
  border: 1px solid #ccc;
  color: #000;
  transition: background-color 0.5s ease, color 0.3s ease;
  }

.quote-select option {
  background-color: white !important; /* Keep dropdown list white */
  color: #000 !important; /* readable text in dropdown */
}
</style>

<script>
function updateSelectColor(select) {
  const colors = {
    accepted: { bg: '#d4edda', text: '#155724' },  // light green
    declined: { bg: '#f8d7da', text: '#721c24' },  // light red
    waiting:  { bg: '#fff3cd', text: '#856404' }   // light yellow
  };
  
  const style = colors[select.value] || { bg: 'white', text: '#000' };
  select.style.backgroundColor = style.bg;
  select.style.color = style.text;
}

// Apply on page load
document.querySelectorAll('.quote-select').forEach(updateSelectColor);
</script><script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
flatpickr('.flatpickr_date', {
enableTime: false,
dateFormat: 'Y-m-d',
altInput: true,
altFormat: 'F j, Y'

})

    flatpickr('.flatpickr_time', {
      enableTime: true,
      noCalendar: true,
      dateFormat: 'H:i',
      altInput: true,
      altFormat: 'h:i K',
      allowInput: true,
      onReady: function (selectedDates, dateStr, instance) {
        instance._input.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace' || e.key === 'Delete') {
            instance.clear()
          }
        })
      }
    })
</script>

    <script>
      function toggleItemsRow(btn) {
        const ul = btn.nextElementSibling
        if (ul.style.display === 'none') {
          ul.style.display = 'block'
          btn.textContent = 'Hide Items'
        } else {
          ul.style.display = 'none'
          btn.textContent = 'Show Items'
        }
      }
      // Scroll to job on load if hash exists
window.addEventListener("load", function () {
if (window.location.hash) {
const el = document.querySelector(window.location.hash);
if (el) {
el.scrollIntoView({ behavior: "instant", block: "center" });
}
}
});

// Preserve hash across pagination
document.querySelectorAll(".pagination a").forEach(link => {
link.addEventListener("click", function() {
if (window.location.hash) {
this.href = this.href + window.location.hash;
}
});
});
    </script>

    <script>
window.addEventListener("load", function () {
let job_id = localStorage.getItem('lastJob');
if (!job_id) return;

let card = document.getElementById(job_id);
if (card) {
  // Apply initial highlight
  card.style.transition = 'border-color 0.3s ease';
  card.style.border = '4px solid #407299ff';
  card.style.padding = '0.5rem 0.5rem';
  
  // Scroll smoothly to the element
  card.scrollIntoView({ behavior: "instant", block: "center" });

  // After 2 seconds, fade out the border
  setTimeout(() => {
    card.style.transition = 'border-color 1s ease';
    card.style.borderColor = 'transparent';
  }, 2000);

  // Cleanup
  localStorage.removeItem('lastJob');
  return;
}
satisfies
  

// If not found, go to next page if available
const nextPageLink = document.querySelector('.pagination .page-link[title="Next"]');
if (nextPageLink) {
// Preserve other query params and hash
nextPageLink.href += '';
nextPageLink.click();
} else {
// Job not found, cleanup
localStorage.removeItem('lastJob');
}
});
</script>

<style>
/* Make text color cascade inside rows with inline color */
tr[style] td,
tr[style] td *,
 {
  color: inherit !important;
}
</style>
<style>

.job-card { background: #f8f9fa; padding: 1rem 1.5rem; border-radius: 10px; }
.job-hint.green { color: rgb(0, 129, 43); font-weight: 500; }
.job-hint.yellow { color: orange; font-weight: 500; }
.badge { display: inline-block; padding: 4px 10px; font-size: 1rem; font-weight: 500; color: white; border-radius: 5px; text-transform: capitalize; overflow-x: hidden; }
.status-ready { background-color: rgb(0, 129, 43); }
.status-paused { background-color: rgb(0, 98, 255); }
.status-cancelled { background-color: rgb(167, 30, 12); }
.status-completed { background-color: rgb(131, 25, 108); }
.status-quoted { background-color: rgb(228, 216, 51); color: #000; }
.tag { padding: 2px 8px; border-radius: 15px; font-size: 0.9rem; margin-left: 10px; display: inline-block; }
.tag.arrived { background: #11ff09; color: #000; }
.tag.ordered { background: #e4d833; color: #000; }
.tag.was-for-job { background: #77a3c0; color: #000; }
.tag.from-warehouse { background: #9d77c0; color: #000; }
.tag.used { background: #360808; color: #fff; }
.tag.not-ordered { background: #ff6262; color: #000; }
.tag.used-info { background-color: rgba(182, 182, 182, 0.79); color: #333; }
.btn-toggle { background-color: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 6px; margin-top: 10px; cursor: pointer; }
.btn-toggle:hover { background-color: #0056b3; }
.inline-form { display: inline; }
 .quote-box {
      display: inline-block;
      padding: 5px 10px;
      font-size: 1.2rem;
      font-weight: normal;
      color: #fff;
      background-color: rgba(153, 165, 48, 1);
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
.quote-accepted { background-color: #00a767ff; color: #ffffffff; padding: 4px 10px; font-size: 1rem; font-weight: 500; border-radius: 5px; text-transform: capitalize; margin-left: 10px; }
.quote-declined { background-color: #6e003dff; color: #fcfcfcff; padding: 4px 10px; font-size: 1rem; font-weight: 500; border-radius: 5px; text-transform: capitalize; margin-left: 10px; }
.quote-unknown { background-color: #fa8500ff; color: #ffffffff; padding: 4px 10px; font-size: 1rem; font-weight: 500; border-radius: 5px; text-transform: capitalize; margin-left: 10px; }

.history-container {
max-height: 350px;   /* limit the height */
overflow-y: auto;    /* enable vertical scrolling */
border-radius: 5px;
padding-right: 5px;  /* avoid scrollbar overlap */
background-color: #dbe3ebff;
overflow-x: none;
}
.history-container .card-body {
background-color: #dbe3ebff;
padding: 10px;
border-radius: 5px;
text-align: center;
}
/* Force wrapping inside job ID header */
.job-card h2 {
display: flex;
flex-wrap: wrap;   /* allow wrapping */
align-items: center;
gap: 8px;          /* spacing between items */
word-break: break-word;
}

/* Prevent badges/quote boxes from overflowing */
.job-card .badge,
 {
max-width: 100%;
white-space: normal;  /* allow text to wrap */
word-wrap: break-word;
}



</style>

  {% endblock %}
